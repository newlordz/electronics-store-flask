{% extends "base.html" %}

{% block title %}Seller Dashboard{% endblock %}

{% block content %}
<div class="container py-5 seller-dashboard">
    <h1 class="mb-4">
        <i class="fas fa-store me-2"></i>Seller Dashboard
    </h1>

    <div class="mb-4">
        <a href="{{ url_for('add_product') }}" class="btn btn-primary animate__animated animate__fadeIn">
            <i class="fas fa-plus-circle me-2"></i>Add New Product
        </a>
    </div>

    <!-- Your Products Section -->
    <div class="card shadow-lg rounded-3 mb-5" id="your-products">
        <div class="card-header bg-primary text-white rounded-top-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-box me-2"></i>Your Products</h5>
            <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#productsTable" aria-expanded="false" aria-controls="productsTable">
                <i class="fas fa-chevron-down me-1"></i>Toggle View
            </button>
        </div>
        <div class="card-body">
            {% if products %}
            <!-- Products Summary -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="text-primary mb-1">{{ products|length }}</h4>
                        <small class="text-muted">Total Products</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="text-success mb-1">{{ products|selectattr('is_active', 'equalto', true)|list|length }}</h4>
                        <small class="text-muted">Active Products</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="text-warning mb-1">{{ products|selectattr('is_promotional', 'equalto', true)|list|length }}</h4>
                        <small class="text-muted">Flash Sales</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="text-info mb-1">{{ products|selectattr('stock', 'gt', 0)|list|length }}</h4>
                        <small class="text-muted">In Stock</small>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Products Table -->
            <div class="collapse" id="productsTable">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Promotion</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr>
                                <td>
                                    <strong>{{ product.name }}</strong><br>
                                    <small class="text-muted">{{ product.description[:50] }}{% if product.description|length > 50 %}...{% endif %}</small>
                                </td>
                                <td><span class="badge bg-secondary">{{ product.category }}</span></td>
                                <td class="price">${{ "%.2f"|format(product.price) }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if product.stock > 0 else 'danger' }}">
                                        {{ product.stock }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if product.is_active else 'danger' }}">
                                        {{ 'Active' if product.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td>
                                    {% if product.is_promotional %}
                                    <div class="d-flex flex-column align-items-start">
                                        <span class="badge bg-warning text-dark mb-1">
                                            <i class="fas fa-fire me-1"></i>Flash Sale
                                        </span>
                                        <small class="text-muted">
                                            ${{ "%.2f"|format(product.promotional_price) }}
                                        </small>
                                        {% if product.promotional_end_date %}
                                        <small class="text-muted">
                                            Ends: {{ product.promotional_end_date.strftime('%m/%d/%Y') }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <span class="badge bg-secondary">Regular</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group-vertical" role="group">
                                        <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-primary btn-sm mb-1">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </a>
                                        <a href="{{ url_for('toggle_product', product_id=product.id) }}" class="btn btn-warning btn-sm mb-1">
                                            <i class="fas fa-toggle-{{ 'off' if product.is_active else 'on' }} me-1"></i>{{ 'Deactivate' if product.is_active else 'Activate' }}
                                        </a>
                                        <a href="{{ url_for('delete_product', product_id=product.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this product?');">
                                            <i class="fas fa-trash-alt me-1"></i>Delete
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-box-open fa-5x text-muted mb-3"></i>
                <h4>No Products Listed</h4>
                <p class="text-muted">You haven't added any products yet. Click "Add New Product" to get started!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Orders Pending Your Approval (Receipts) Section -->
    <div class="card shadow-lg rounded-3 mb-5" id="orders-pending-approval">
        <div class="card-header bg-primary text-white rounded-top-3">
            <h5 class="mb-0"><i class="fas fa-file-invoice-dollar me-2"></i>Orders Pending Your Approval (Receipts)</h5>
        </div>
        <div class="card-body">
            {% if orders_pending_seller_approval %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Buyer</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders_pending_seller_approval %}
                        <tr>
                            <td><code>{{ order.id[:8] }}...</code></td>
                            <td>{{ get_user_by_id(order.buyer_id).username if get_user_by_id(order.buyer_id) else 'N/A' }}</td>
                            <td class="price">
                                ${{ "%.2f"|format(order.total_amount) }}
                                {% if order.discount_code %}
                                <br><small class="text-success">
                                    <i class="fas fa-tag me-1"></i>{{ order.discount_code }} ({{ order.discount_percentage }}% off)
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="order-status status-{{ order.status.replace('_', '-') }}">
                                    {{ order.status.replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    <a href="{{ url_for('receipt', order_id=order.id) }}" class="btn btn-outline-primary btn-sm flex-fill">
                                        <i class="fas fa-info-circle me-1"></i>Details
                                    </a>
                                    <a href="{{ url_for('order_comments', order_id=order.id) }}" class="btn btn-outline-info btn-sm flex-fill">
                                        <i class="fas fa-comments me-1"></i>Chat
                                    </a>
                                    <button type="button" class="btn btn-success btn-sm flex-fill animate__animated animate__pulse animate__infinite" data-action="seller_approve" data-order-id="{{ order.id }}">
                                        <i class="fas fa-check-circle me-1"></i>Approve
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-clipboard-check fa-5x text-muted mb-3"></i>
                <h4>No Receipts Awaiting Approval</h4>
                <p class="text-muted">New orders will appear here after buyers complete payment.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- All Your Orders Section -->
    <div class="card shadow-lg rounded-3" id="all-orders">
        <div class="card-header bg-primary text-white rounded-top-3">
            <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>All Your Orders</h5>
        </div>
        <div class="card-body">
            {% if orders %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Buyer</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td><code>{{ order.id[:8] }}...</code></td>
                            <td>{{ get_user_by_id(order.buyer_id).username if get_user_by_id(order.buyer_id) else 'N/A' }}</td>
                            <td class="price">
                                ${{ "%.2f"|format(order.total_amount) }}
                                {% if order.discount_code %}
                                <br><small class="text-success">
                                    <i class="fas fa-tag me-1"></i>{{ order.discount_code }} ({{ order.discount_percentage }}% off)
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="order-status status-{{ order.status.replace('_', '-') }}">
                                    {{ order.status.replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td>{{ order.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <div class="d-flex gap-1">
                                    <a href="{{ url_for('receipt', order_id=order.id) }}" class="btn btn-outline-primary btn-sm flex-fill">
                                        <i class="fas fa-info-circle me-1"></i>Details
                                    </a>
                                    <a href="{{ url_for('order_comments', order_id=order.id) }}#all-orders" class="btn btn-outline-info btn-sm flex-fill">
                                        <i class="fas fa-comments me-1"></i>Chat
                                    </a>
                                    {% if order.status == 'approved' %}
                                    <button type="button" class="btn btn-warning btn-sm flex-fill" data-action="seller_mark_delivered" data-order-id="{{ order.id }}">
                                        <i class="fas fa-truck me-1"></i>Delivered
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-receipt fa-5x text-muted mb-3"></i>
                <h4>No Orders</h4>
                <p class="text-muted">No orders have been placed for your products yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-question-circle me-2"></i>Confirm Action
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmButton">
                    <i class="fas fa-check me-1"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Override browser confirm to prevent native dialogs
const originalConfirm = window.confirm;
window.confirm = function(message) {
    console.log('Browser confirm intercepted:', message);
    return false; // Always return false to prevent any browser confirmations
};

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Handle approve receipt buttons
    const approveButtons = document.querySelectorAll('[data-action="seller_approve"]');
    approveButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const orderId = this.getAttribute('data-order-id');
            showConfirmationModal(
                'Approve Receipt',
                'Are you sure you want to approve this receipt? This will send the order to admin for final review.',
                'Approve',
                'btn-success',
                () => approveReceipt(orderId)
            );
        });
    });
    
    // Handle mark as delivered buttons
    const deliveredButtons = document.querySelectorAll('[data-action="seller_mark_delivered"]');
    deliveredButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const orderId = this.getAttribute('data-order-id');
            showConfirmationModal(
                'Mark as Delivered',
                'Are you sure you want to mark this order as delivered? This will complete the order process.',
                'Mark Delivered',
                'btn-warning',
                () => markAsDelivered(orderId)
            );
        });
    });
    
    // Handle smooth scrolling to sections when page loads with hash
    if (window.location.hash) {
        const targetElement = document.querySelector(window.location.hash);
        if (targetElement) {
            setTimeout(() => {
                // Use scrollIntoView for better performance
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100); // Reduced delay for faster response
        }
    }
});

// Show confirmation modal
function showConfirmationModal(title, message, confirmText, confirmClass, onConfirm) {
    const modal = document.getElementById('confirmationModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const confirmBtn = document.getElementById('confirmButton');
    
    // Update modal content
    modalTitle.innerHTML = `<i class="fas fa-question-circle me-2"></i>${title}`;
    modalMessage.textContent = message;
    confirmBtn.textContent = confirmText;
    confirmBtn.className = `btn ${confirmClass}`;
    
    // Remove any existing click handlers
    confirmBtn.onclick = null;
    
    // Set up confirmation action
    confirmBtn.onclick = function() {
        const bootstrapModal = bootstrap.Modal.getInstance(modal);
        bootstrapModal.hide();
        onConfirm();
    };
    
    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal, {
        backdrop: 'static',
        keyboard: false
    });
    bootstrapModal.show();
}

// Approve receipt function
function approveReceipt(orderId) {
    fetch("{{ url_for('vendor_approve_receipt', order_id='PLACEHOLDER') }}".replace('PLACEHOLDER', orderId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'csrf_token=' // Empty body since we removed CSRF
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to approve receipt. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to approve receipt. Please try again.');
    });
}

// Mark as delivered function
function markAsDelivered(orderId) {
    fetch("{{ url_for('customer_confirm_delivery', order_id='PLACEHOLDER') }}".replace('PLACEHOLDER', orderId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'csrf_token=' // Empty body since we removed CSRF
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to mark as delivered. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to mark as delivered. Please try again.');
    });
}
</script>
{% endblock %}
