{% extends "base.html" %}
{% block title %}My Wishlist{% endblock %}
{% block content %}
<div class="container py-5 wishlist-page">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4 text-center">
                <i class="fas fa-heart text-danger me-2"></i>My Wishlist
            </h1>
            <p class="text-muted text-center mb-5">Your saved items for later purchase</p>
        </div>
    </div>
    
    {% if products %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
        {% for product in products %}
            <div class="col">
                <div class="card product-card h-100 animate__animated animate__fadeInUp">
                    <div class="position-relative">
                                                                                                         <img src="{{ url_for('static', filename='uploads/' + product.image_filename) }}"  
                             class="card-img-top" 
                             alt="{{ product.name }}"
                                                           onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/electronics-store-ad.jpg') }}';">
                        {% if product.is_promotional %}
                        <div class="position-absolute top-0 start-0 m-2">
                            <span class="badge bg-danger">Sale</span>
                        </div>
                        {% endif %}
                        <button class="btn btn-outline-danger remove-from-wishlist-btn position-absolute top-0 end-0 m-2" 
                                data-product-id="{{ product.id }}" 
                                title="Remove from Wishlist">
                            <i class="fas fa-heart-broken"></i>
                        </button>
                    </div>
                    
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title product-title">{{ product.name }}</h5>
                        <p class="card-text text-muted product-description flex-grow-1">{{ product.description[:80] }}{% if product.description|length > 80 %}...{% endif %}</p>
                        
                        <div class="price-section mb-3">
                            {% if product.is_promotional %}
                            <div class="original-price text-muted text-decoration-line-through small">${{ "%.2f"|format(product.price) }}</div>
                            <div class="promotional-price fw-bold text-success">${{ "%.2f"|format(product.promotional_price) }}</div>
                            <div class="savings-badge">
                                <span class="badge bg-success">
                                    Save ${{ "%.2f"|format(product.price - product.promotional_price) }}
                                </span>
                            </div>
                            {% else %}
                            <div class="price fw-bold">${{ "%.2f"|format(product.price) }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="stock-info mb-3">
                            <span class="text-muted small">
                                <i class="fas fa-box text-info me-1"></i>{{ product.stock }} in stock
                            </span>
                        </div>
                        
                        <div class="product-actions mt-auto">
                            <div class="d-flex gap-2 mb-2">
                                <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn btn-outline-primary btn-sm flex-fill">
                                    <i class="fas fa-eye me-1"></i>View
                                </a>
                                <form class="ajax-cart-form flex-fill" action="{{ url_for('add_to_cart_route', product_id=product.id) }}" method="POST">
                                    <button type="submit" class="btn btn-primary btn-sm w-100 add-to-cart-btn" data-product-id="{{ product.id }}">
                                        <i class="fas fa-cart-plus me-1"></i>Add
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5">
            <div class="empty-wishlist">
                <i class="fas fa-heart-broken fa-5x text-muted mb-4"></i>
                <h3 class="text-muted mb-3">Your Wishlist is Empty</h3>
                <p class="text-muted mb-4">Start adding items to your wishlist to save them for later!</p>
                <a href="{{ url_for('products_list') }}" class="btn btn-primary">
                    <i class="fas fa-shopping-bag me-2"></i>Browse Products
                </a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Wishlist page specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize remove from wishlist functionality
    initializeRemoveFromWishlist();
    
    function initializeRemoveFromWishlist() {
        const removeButtons = document.querySelectorAll('.remove-from-wishlist-btn');
        
        removeButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const productId = this.dataset.productId;
                const card = this.closest('.col');
                const originalHTML = this.innerHTML;
                
                // Show loading state
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                this.disabled = true;
                
                // Send AJAX request
                fetch(`/remove_from_wishlist/${productId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success toast
                        showToast('Removed from wishlist!', 'success');
                        
                        // Animate card removal
                        card.style.transition = 'all 0.3s ease';
                        card.style.transform = 'scale(0.8)';
                        card.style.opacity = '0';
                        
                        setTimeout(() => {
                            card.remove();
                            
                            // Check if no more items
                            const remainingCards = document.querySelectorAll('.product-card');
                            if (remainingCards.length === 0) {
                                location.reload(); // Reload to show empty state
                            }
                        }, 300);
                    } else {
                        // Show error
                        showToast(data.message || 'Error removing from wishlist', 'error');
                        this.innerHTML = originalHTML;
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error removing from wishlist', 'error');
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                });
            });
        });
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        bsToast.show();
        
        // Remove toast element after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }
});
</script>
{% endblock %} 